// Generated by CoffeeScript 1.3.3
(function() {

  $(function() {
    var cleanPosts, evtSrc, onError, onMessage, onOpen, synthesizeLink,
      _this = this;
    evtSrc = new EventSource("io");
    synthesizeLink = function(url, index) {
      var fileName, href, link, linkText;
      linkText = "攻略" + (index + 1);
      fileName = linkText + url.split('.').pop();
      href = ("" + url) + ("#name=" + linkText) + '&content-type=image/jpeg' + '&filepath=/sdcard/travel/';
      link = $("<a>" + linkText + "</a>");
      link.attr('href', href);
      link.attr('download', fileName);
      link.attr('name', url);
      return link;
    };
    cleanPosts = function(soup) {
      var cleaned, posts;
      posts = $("li", soup);
      cleaned = [];
      _.each(posts, function(e, i, l) {
        return cleaned.push($(e).find(".pic img"));
      });
      return cleaned;
    };
    onMessage = function(e) {
      var cleaned, data,
        _this = this;
      $('#loading').fadeOut();
      data = JSON.parse(e.data);
      if (data) {
        _.each(data.ImgList, function(element, index, list) {
          $('#result-list').append(synthesizeLink(element, index));
          return _this;
        });
        cleaned = cleanPosts(data.Posts);
        return _.each(cleaned, function(element, index, list) {
          $('#result-list').append(element);
          return _this;
        });
      }
    };
    onOpen = function(e) {
      console.log('opened');
      return this;
    };
    onError = function(e) {
      var statusStr;
      statusStr = "";
      switch (e.eventPhase) {
        case 0:
          statusStr = "CONNECTING";
          break;
        case 1:
          statusStr = "OPEN";
          break;
        case 2:
          statusStr = "CLOSED";
      }
      return console.log(statusStr);
    };
    evtSrc.addEventListener("message", onMessage, false);
    evtSrc.addEventListener("open", onOpen, false);
    return evtSrc.addEventListener("error", onError, false);
  });

}).call(this);
